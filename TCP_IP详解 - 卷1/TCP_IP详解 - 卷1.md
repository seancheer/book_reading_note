[TOC]



### 一：概述

- 传输层的端口号是16位的非负整数（范围是`0~65535`），这些数字是抽象的，在物理上面没有任何实质的东西，这点需要注意。
- TCP会处理数据包的丢失，重复和重新排序等IP层不处理的问题，它采用面向连接的方式，并且不保留消息边界。相反，UDP仅提供比IP协议稍多的功能，允许应用发送数据报并保留消息边界，但不强制实现速率控制和差错控制。
### 二：Internet地址结构
- 为了减少Intenert中路由的条目数量，可采用树的方式对ip地址进行不同程度的聚合，并且采用分层路由的方式，将相邻的多个IP前缀合并成一个短前缀（相当于夸大范围的聚合方式），这种技术叫做`CIDR`。如下图所示，表示了一个聚合的过程：

![ip路由聚合方式](2E7A2081DDB544288318EF9E15BCEE7C)

- 互联网中也存在很多的组播服务，不只是本地网络支持该功能，比如常见的NTP服务就是利用了这个功能。


### 三：链路层
#### 1 以太网和IEEE 802局域网 / 城域网标准
- 一般的以太网帧大小范围为：**64-1518字节**，当然，不是只有一个范围，还有**Q标签帧**和**信封帧**，他们的最小大小都一样，最大值有所不同。最小帧被设置为64字节是因为物理层面，和电子的传播速度有关，具体可以网络上搜索下，不需要太过于关心。如果帧的长度不够64字节，则需要在payload末尾添加数个0来达到最小长度要求。下面表示以太网帧格式：

![以太网帧格式](829B191BA52B47C7BD389D510E869E3D)
- 为了解决大型多用途交换网络运行中的问题，IEEE采用一种称为``虚拟局域网（VLAN）``的技术。``VLAN``的划分方法如下：
> 通过端口来分配，比较常见；<br>
> 基于MAC地址来分配，如果局域网中某些用户修改了MAC地址，那么将变得难于管理；<br>
> 通过IP地址来分配
- 链路层的流量控制
> 当多个站发送到同一目的地时，如果一个站聚合的流量速率超过该站的链路速率，那么帧就开始存储在中间交换机上， 情况如果持续一段时间，这些帧就可能会被丢弃。此时，链路层可以使用``PAUSE``消息来实现流量控制的目的，``PAUSE``信息包含在MAC控制帧中，通过将以太网长度/类型字段值设为``0x8808``来实现。<br>
> **注意，以太网层次的流量控制可能会有重大的负面影响，因此通常并不会使用该技术，比如当多个站通过一台过载的交换机发送帧时，该交换机会给所有的主机都发送``PAUSE``消息，这样子有的主机并不是交换机过载的罪魁祸首，也会收到对应的``PAUSE``消息。**

- 网桥和交换机：交换机本质上是一种高性能的网桥，其最基本的设置就是连接两个交换机来形成拓展的局域网。
- 交换机打开后需要经过一段时间来学习哪个站可以通过哪个口到达，以下是一个常见的交换机数据库：
![交换机数据库](AE3D5DC4D8DA44169F69C7118493EE6C)
- 洪泛：当交换机数据库中的某个条目过期后，后续的帧会被发送给除了该端口之外的所有端口，这样子就产生了洪泛，在复杂的交换机拓扑里面，这样子可能会产生无穷无尽的洪泛，此时，变产生了一个叫做``生成树协议（STP）``的技术来解决这个问题，该协议产生的报文叫做``网桥协议数据单元（BPDU）``，该报文放在``802帧的payload``位置。关于该协议的详情可以参考P70
- ``STP和RSTP``：``RSTP``是``STP``的改进版本，在``RSTP``中，如果监测到一次拓扑变化的交换机会发送一个表示拓扑变化的``BPDU``，**任何接收到该帧的交换机会立即清除自己的过滤数据库**，该改变可以显著影响协议的收敛时间，无须等待拓扑变化传递到根网桥在经过转发延迟后返回。在大多数情况下，收敛时间可以从几十秒减少到几分之一秒。

#### 2 无线局域网 - IEEE 802.11（WI-FI)
- 802.11帧被称为MPDU，该帧以帧控制字开始，其中包括2位的类型字段，用于识别该帧的类型，包含三种类型：管理帧，控制帧，数据帧。其中作用如下：
> 管理帧：用于创建，维持，终止站和接入点之间的连接，他们也被用于确定是否采用加密，传输网络名称（SSID或ESSID），支持哪种传输速率，以及采用的时间数据库等。<br>
> 控制帧：用于一种流量控制方式，流量控制有助于接收方使一个过快的发送方降低发送速度。<br>
> 数据帧：顾名思义，携带数据的帧。
- WIFI在链路层也支持数据帧的分片和聚合功能。
#### 3 点到点协议（PPP）
- 该协议可以简单理解链路层的协议，在链路建立起来后，会对上层的协议报文进行封装，一般封装完在链路层叫做NCP协议。
- **该协议**只关注点到点的链路，也就是一条链路的两端，不需要像以太网和WIFI的MAC层协议那样处理共享资源访问的问题；**该协议**用来在串行链路上传输IP数据包的流行方法，本质上是一个协议集合，而不是一个单一的协议，它支持建立连接的基本方法 - 称为`链路控制协议（LCP）`，以及一系列`NCP协议`，在`LCP`建立了基本链路之后，用于为各种协议（包括`IPv4， IPv6和非IP协议`）建立网络层的链路。
- ``LCP``：使一条点到点链路达到最低要求，配置消息使链路两端开始基本配置过程，并建立商定的选项。终止信息用于在完成后清除一条链路。
- ``CCP``：链路层的``压缩控制协``，用来对PPP帧进行压缩操作；
- ``CHAP``：``查询-握手认证协议``，用于在链路层进行认证操作
- ``NCP``：``网络控制协议``，在LCP完成链路建立和认证之后，此时链路两端都进入网路状态，并使用一个或者多个NCP进行网络层的相关协商。该协议支持压缩功能，由于TCP/IPv4头部40个字节经常会有大量的重复内容，因此使用该协议可以对该头部进行压缩，从而达到节约带宽的目的。
#### 4 MTU和路径MTU
- 一个链路上，最小的MTU称为路径MTU，任何两台主机之间的MTU不会永远不变，取决于当前使用的路径，如果网络中的路由器或者链路故障，MTU就可能发生改变，另外，路径通常不对称，主机A到B路径可能不是B到A的反向路径，路径MTU不需要在两个方向上保持相同。
#### 5 隧道基础
- 两台计算机通过Internet或者其他网络建立一条虚拟链路，`VPN`可以提供这种服务，实现这类服务的方法称为`隧道`，一般来讲，隧道时在高层（或者同等层）分组中携带低层数据，例如，在一个IPv4或者IPv6分组中携带IPv4数据，在一个UDP,IPv4或者IPv6分组中携带以太网数据。用于建立隧道的常用的3中协议：`通用路由封装（GRE），Microsoft专用的点对点隧道协议（PPTP），第2层隧道协议（L2TP`）。

### 四：地址解析协议

- `ARP协议`的报文格式如下：

  ![](C:\Users\seancheer\Desktop\Programming\读书笔记\TCP_IP详解 - 卷1\res\arp报文格式.jpg)

- `ARP协议`的`Op字段`如下：

  > 1表示请求，2表示应答，3表示RARP请求，4表示RARP应答。

- ARP还有一个功能称为**`免费ARP`**，可以通过该功能达成以下目的：

  > - 当前主机通过免费ARP来确定另外一台主机是否配置了和自己一样的IP
  > - 如果当前主机改变了自己的硬件地址（比如关闭主机或者替换网卡，然后重新启动），此时可通过发送免费ARP的方式来更新其他主机对于自己的记录。

- 虽然**`免费ARP`**可以确定一个网络域中是否有其他主机的IP和自己相同，但是却没有提供有效的解决办法，`RFC`提出了一种IPv4地址冲突检测（`ACD`）的方式来探测和解决IP地址冲突的问题，**`ACD`**定义了`ARP探测分组`和`ARP通告分组`。探测分组用于查看一个候选的IPv4地址是否被广播域中其他主机使用，而通告分组则是通告发送发即将使用该IPv4地址的意图。当然，当前很少使用`ARP协议`来设置IP地址了，而是使用`DHCP`的方式来解决获取IP地址的问题。

### 五：Internet协议（IP协议）目前更新到这里了

- IPv4头部信息如下：

  ![](C:\Users\seancheer\Desktop\Programming\读书笔记\TCP_IP详解 - 卷1\res\ipv4头部格式.jpg)

- IPv6的头部格式如下：

  ![](C:\Users\seancheer\Desktop\Programming\读书笔记\\TCP_IP详解 - 卷1\res\ipv6头部格式.jpg)

- 关于IPv4和IPv6的相同点和不同点重点区别如下：

  > 1. IPv4的头部为20个字节（因为包含`option`字段，所以本质上是可变的，最大为60字节），而IPv6为60个字节，且去除掉了IPv4中的很多字段。
  > 2. IPv4头部的检验和只保证头部字段被正确发送到目的地，但不保证数据内容是否证据，且IPv6头部中去除掉了校验和字段。
  > 3. Internet头部长度**IHL**保存IPv4头部中32位字的数量，由于是一个4位的字段，所以IPv4头部被限制为最多60个字节。
  > 4. 总长度字段是IPv4数据报的总长度，集合IHL字段可以推算出`payload`的开始位置。
  > 5. `DS`和`ECN`的前身是`ToS`，即服务类型的意思，用来对流量类型和优先进行区分，以达到针对性服务的目的。
  > 6. IPv6虽然去掉了头部`checksum`字段，但是其报文的完整性由更高层协议来进行保证。
  > 7. IPv6通过`下一个头部`字段，来实现只有IPv4中才提供的特殊功能，下一个头部可以指向传输层头部也可以指向自身的拓展头部。

- IPv6的拓展头部哦通过下一个头部字段进行链式的连接，示意图如下：

  ![](C:\Users\seancheer\Desktop\Programming\读书笔记\\TCP_IP详解 - 卷1\res\ipv6下一个头部的连接方式.jpg)

  **其中，规定的IPv6下一个头部的类型有：IPv6头部，逐跳选项，目的地选项，路由，分片，封装安全载荷（ESP），认证（AH），移动（MIPv6），无-没有下一个头部，ICMPv6，UDP，TCP， 各种其他高层协议等。**

- IPv6选项也是通过链式的方式来进行连接的，其格式如下所示：

  ![](C:\Users\seancheer\Desktop\Programming\读书笔记\TCP_IP详解 - 卷1\res\ipv6拓展头部的选项格式.jpg)

  **其中，所有的IPv6选项有：`填充1，填充N（这两个是负责填充数据对齐8字节用的），超大有效载荷，隧道封装限制，路由器警告，快速启动，CALIPSO（多用于专用网络，如银行等对安全看重的网络环境），家乡地址（负责和移动IP通信的技术）`**

- IPv6路由头部：目前使用到的是`RH2`，`RH0`已经被废弃，因为`RH0`中的路由表是可以有重复值的，可能会被利用做`DoS`攻击。

- IPv6分片头部：在IPv4中，如果数据报的大小超过下一跳的`MTU`，任何主机或者路由器都可以将该数据报进行分片，**但是在IPv6中，只有发送者可以执行分片功能。**